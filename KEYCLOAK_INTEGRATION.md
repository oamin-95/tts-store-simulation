# ğŸ” ØªÙˆØ«ÙŠÙ‚ ØªÙƒØ§Ù…Ù„ Keycloak Ù…Ø¹ Ù†Ø¸Ø§Ù… SaaS Marketplace

**ğŸ“… Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:** 2025-11-20
**ğŸ”§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±:** 2.1

---

## ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª

1. [Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙŠÙƒÙ„](#Ù†Ø¸Ø±Ø©-Ø¹Ø§Ù…Ø©-Ø¹Ù„Ù‰-Ø§Ù„Ù‡ÙŠÙƒÙ„)
2. [Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©](#Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª-Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©)
3. [Ø§Ù„Ø¹Ø²Ù„ ÙˆØ§Ù„Ø£Ù…Ø§Ù†](#Ø§Ù„Ø¹Ø²Ù„-ÙˆØ§Ù„Ø£Ù…Ø§Ù†)
4. [Ø¢Ù„ÙŠØ© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©](#Ø¢Ù„ÙŠØ©-Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©)
5. [Ø¶Ø¨Ø· Social Login Key ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„](#Ø¶Ø¨Ø·-social-login-key-ÙˆØªØ³Ø¬ÙŠÙ„-Ø§Ù„Ø¯Ø®ÙˆÙ„)
6. [Ø¯ÙˆØ±Ø© Ø­ÙŠØ§Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ](#Ø¯ÙˆØ±Ø©-Ø­ÙŠØ§Ø©-Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ)
7. [Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª](#Ù…Ø²Ø§Ù…Ù†Ø©-Ø§Ù„Ø£Ø¯ÙˆØ§Ø±-ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª)
8. [Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±](#Ø¥Ø¯Ø§Ø±Ø©-Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†-Ù…Ù†-Ø§Ù„Ù…ØªØ¬Ø±)
9. [Queue Workers Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©](#queue-workers-Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©)
10. [Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„Ø©](#Ø§Ù„Ø£ÙƒÙˆØ§Ø¯-Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„Ø©)
11. [Ø§Ø³ØªÙƒØ´Ø§Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡](#Ø§Ø³ØªÙƒØ´Ø§Ù-Ø§Ù„Ø£Ø®Ø·Ø§Ø¡)

---

## ğŸ—ï¸ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙŠÙƒÙ„

### Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Keycloak Container                            â”‚
â”‚                    (localhost:8090)                              â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Master Realm                                               â”‚ â”‚
â”‚  â”‚  â””â”€ Service Account: saas-marketplace-admin               â”‚ â”‚
â”‚  â”‚     â”œâ”€ Client ID: saas-marketplace-admin                  â”‚ â”‚
â”‚  â”‚     â”œâ”€ Client Secret: JIBnwkGRp4VBPvV4d2bfg1N4iwXvEMvV    â”‚ â”‚
â”‚  â”‚     â””â”€ Permissions:                                       â”‚ â”‚
â”‚  â”‚        âœ“ create-realm                                     â”‚ â”‚
â”‚  â”‚        âœ“ manage-clients (per realm)                       â”‚ â”‚
â”‚  â”‚        âœ“ manage-users (per realm)                         â”‚ â”‚
â”‚  â”‚        âœ“ view-realm (per realm)                           â”‚ â”‚
â”‚  â”‚        âœ— delete-realm (Ù…Ù…Ù†ÙˆØ¹ Ù„Ù„Ø£Ù…Ø§Ù†)                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Tenant Realm: tenant-{user_id}                            â”‚ â”‚
â”‚  â”‚  â”œâ”€ Users (managed by marketplace)                        â”‚ â”‚
â”‚  â”‚  â”œâ”€ Groups (synced from products)                         â”‚ â”‚
â”‚  â”‚  â””â”€ Clients:                                              â”‚ â”‚
â”‚  â”‚     â”œâ”€ training-platform                                  â”‚ â”‚
â”‚  â”‚     â”‚  â”œâ”€ Type: Service Account                           â”‚ â”‚
â”‚  â”‚     â”‚  â”œâ”€ Secret: {unique_secret_per_subscription}        â”‚ â”‚
â”‚  â”‚     â”‚  â””â”€ Permissions: manage-users, query-groups, etc.   â”‚ â”‚
â”‚  â”‚     â”œâ”€ services-platform                                  â”‚ â”‚
â”‚  â”‚     â”‚  â”œâ”€ Type: Service Account                           â”‚ â”‚
â”‚  â”‚     â”‚  â”œâ”€ Secret: {unique_secret_per_subscription}        â”‚ â”‚
â”‚  â”‚     â”‚  â””â”€ Permissions: manage-users, query-groups, etc.   â”‚ â”‚
â”‚  â”‚     â””â”€ kayan-erp                                          â”‚ â”‚
â”‚  â”‚        â”œâ”€ Type: Service Account + Standard Flow          â”‚ â”‚
â”‚  â”‚        â”œâ”€ Secret: {unique_secret_per_subscription}        â”‚ â”‚
â”‚  â”‚        â”œâ”€ Redirect URIs: http://localhost:{port}/*        â”‚ â”‚
â”‚  â”‚        â””â”€ Permissions: manage-users, manage-realm, etc.   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–²                    â–²                    â–²
           â”‚                    â”‚                    â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚ Marketplace â”‚     â”‚  Training   â”‚     â”‚  Services   â”‚
    â”‚  (Port 4000)â”‚     â”‚ (Port 5000) â”‚     â”‚ (Port 7000) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â–²
                                â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   Kayan ERP    â”‚
                        â”‚ (Dynamic Port) â”‚
                        â”‚ (Port 40896+)  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ù…Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ø²Ù„ (Isolation)

1. **Ø¹Ø²Ù„ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Realm**: ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø± Ù„Ù‡ Realm Ù…Ø¹Ø²ÙˆÙ„ Ø®Ø§Øµ Ø¨Ù‡
2. **Ø¹Ø²Ù„ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Client**: ÙƒÙ„ Ù…Ù†ØªØ¬ Ù„Ù‡ Client Ù…Ù†ÙØµÙ„ Ø¨Ù…ÙØªØ§Ø­ Ø³Ø±ÙŠ ÙØ±ÙŠØ¯
3. **Ø¹Ø²Ù„ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª**: ÙƒÙ„ Client Ù„Ù‡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø­Ø¯ÙˆØ¯Ø© ÙÙ‚Ø· Ù„Ù€ Realm Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡


---

## ğŸ¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©

### 1. Training Platform (Laravel Multi-tenant)

**Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª:**
- Laravel 12
- Port: 5000

**Ø¢Ù„ÙŠØ© Ø§Ù„Ø¹Ù…Ù„:**
- Schema Ù…Ù†ÙØµÙ„ Ù„ÙƒÙ„ tenant
- Domain-based routing: `training-user-{id}-{timestamp}.localhost`
- OIDC authentication via Keycloak

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:**
- `/training-platform/app/Http/Controllers/Api/KeycloakWebhookController.php`
- `/training-platform/app/Services/KeycloakAdminService.php`

---

### 2. Services Platform (Laravel Multi-tenant)

**Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª:**
- Laravel 12
- Port: 7000

**Ø¢Ù„ÙŠØ© Ø§Ù„Ø¹Ù…Ù„:**
- Schema Ù…Ù†ÙØµÙ„ Ù„ÙƒÙ„ tenant
- Domain-based routing: `services-user-{id}-{timestamp}.localhost`
- OIDC authentication via Keycloak

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:**
- `/services-platform/app/Http/Controllers/Api/KeycloakWebhookController.php`
- `/services-platform/app/Services/KeycloakAdminService.php`
- `/services-platform/app/Http/Controllers/Auth/KeycloakController.php` - Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
- `/services-platform/resources/views/filament/pages/auth/login.blade.php` - Ø²Ø± SSO

---

### 3. Kayan ERP (Frappe/ERPNext)

**Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª:**
- Frappe Framework 14
- ERPNext
- MariaDB
- Dynamic Ports: 40000+

**Ø¢Ù„ÙŠØ© Ø§Ù„Ø¹Ù…Ù„:**
- **Ù…ÙˆÙ‚Ø¹ Ù…Ø¹Ø²ÙˆÙ„ ØªÙ…Ø§Ù…Ø§Ù‹** (fully isolated site) Ù„ÙƒÙ„ tenant
- Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†ÙØµÙ„Ø©: `kayan-user-{id}`
- Ù…Ù†ÙØ° Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ: ÙŠØªÙ… ØªØ®ØµÙŠØµÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ù…Ø«Ø§Ù„: 40896)
- Domain: `kayan-user-{id}.local`
- **OIDC authentication** via Keycloak + **Client Credentials** for role sync

**Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø®Ø§ØµØ©:**
- âœ… Ø¹Ø²Ù„ ÙƒØ§Ù…Ù„ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (site-level isolation)
- âœ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… OAuth 2.0 Client Credentials
- âœ… Ù„Ø§ ÙŠØ­ØªØ§Ø¬ Ù„Ù€ Keycloak Admin credentials
- âœ… ÙƒÙ„ Ù…ÙˆÙ‚Ø¹ Ù„Ù‡ App Server Ù…Ù†ÙØµÙ„

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:**
- `/kayan-erp/apps/oidc_extended/oidc_extended/setup.py`
- `/kayan-erp/apps/oidc_extended/oidc_extended/sync.py`
- `/kayan-erp/scripts/create_tenant_site.py`

---

## ğŸ”’ Ø§Ù„Ø¹Ø²Ù„ ÙˆØ§Ù„Ø£Ù…Ø§Ù†

### 1. ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ØªØ¬Ø± (Marketplace Service Account)

Ø§Ù„Ù…ØªØ¬Ø± ÙŠØªØµÙ„ Ø¨Ù€ Keycloak Ø¹Ø¨Ø± Service Account Ø¨Ù…ÙØªØ§Ø­ Ø³Ø±ÙŠ Ø«Ø§Ø¨Øª:

```env
# .env
KEYCLOAK_SERVICE_CLIENT_ID=saas-marketplace-admin
KEYCLOAK_SERVICE_CLIENT_SECRET=JIBnwkGRp4VBPvV4d2bfg1N4iwXvEMvV
```

#### ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ù„Ù‰ Master Realm:
```
âœ“ default-roles-master       # Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
âœ“ create-realm                # Ø¥Ù†Ø´Ø§Ø¡ Realms Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø·
âœ— delete-realm                # Ù…Ù…Ù†ÙˆØ¹ (Ù„Ù„Ø£Ù…Ø§Ù†)
```

#### ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ù„Ù‰ ÙƒÙ„ Tenant Realm (Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©):
```
âœ“ view-clients                # Ø¹Ø±Ø¶ Clients
âœ“ query-clients               # Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Clients
âœ“ manage-clients              # Ø¥Ø¯Ø§Ø±Ø© Clients (Ø¥Ù†Ø´Ø§Ø¡ØŒ ØªØ¹Ø¯ÙŠÙ„ØŒ Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ§Øª)
âœ“ manage-identity-providers   # Ø¥Ø¯Ø§Ø±Ø© Ù…Ø²ÙˆØ¯ÙŠ Ø§Ù„Ù‡ÙˆÙŠØ©
âœ“ view-identity-providers     # Ø¹Ø±Ø¶ Ù…Ø²ÙˆØ¯ÙŠ Ø§Ù„Ù‡ÙˆÙŠØ©
âœ“ view-authorization          # Ø¹Ø±Ø¶ Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª
âœ“ query-users                 # Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
âœ“ query-realms                # Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Realms
âœ“ view-users                  # Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
âœ“ manage-users                # Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ø¥Ù†Ø´Ø§Ø¡ØŒ ØªØ¹Ø¯ÙŠÙ„ØŒ Ø­Ø°Ù)
âœ“ query-groups                # Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
âœ“ manage-realm                # Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Realm
âœ— impersonation               # Ù…Ù…Ù†ÙˆØ¹ (Ù„Ù„Ø£Ù…Ø§Ù†)
```

**âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ù…Ù†ÙŠØ© Ù…Ù‡Ù…Ø©:**
- Ø§Ù„Ù…ØªØ¬Ø± **Ù„Ø§ ÙŠÙ…ØªÙ„Ùƒ** ØµÙ„Ø§Ø­ÙŠØ© `delete-realm` - Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù‡ Ø­Ø°Ù Realms
- Ø§Ù„Ù…ØªØ¬Ø± **Ù„Ø§ ÙŠÙ…ØªÙ„Ùƒ** ØµÙ„Ø§Ø­ÙŠØ© `impersonation` - Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù†ØªØ­Ø§Ù„ Ø´Ø®ØµÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
- ÙƒÙ„ ØµÙ„Ø§Ø­ÙŠØ© Ù…Ù‚ÙŠØ¯Ø© Ø¨Ù€ Realm Ù…Ø­Ø¯Ø¯ ÙÙ‚Ø·

---

### 2. ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Product Service Accounts)

#### Training & Services Platform Client:

```
Client ID: training-platform (Ø£Ùˆ services-platform)
Client Secret: {generated_unique_secret}
Grant Types: client_credentials
```

**Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:**
```
âœ“ manage-users      # Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
âœ“ view-users        # Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
âœ“ query-users       # Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
âœ“ query-groups      # Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
âœ“ view-realm        # Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Realm
âœ“ manage-realm      # Ø¥Ø¯Ø§Ø±Ø© Realm (Ù…Ø­Ø¯ÙˆØ¯)
```

#### Kayan ERP Client:

```
Client ID: kayan-erp
Client Secret: {generated_unique_secret}
Grant Types: authorization_code, client_credentials
Standard Flow: Enabled (Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†)
Service Account: Enabled (Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø±)
Direct Access Grants: Enabled
```

**Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:**
```
âœ“ manage-users      # Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
âœ“ view-users        # Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
âœ“ query-users       # Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
âœ“ query-groups      # Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
âœ“ view-realm        # Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Realm
âœ“ manage-realm      # Ø¥Ø¯Ø§Ø±Ø© Realm (Ø¥Ù†Ø´Ø§Ø¡ Groups)
```

**Redirect URIs Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ Kayan ERP:**
```
http://localhost:{dynamic_port}/*
http://localhost:{dynamic_port}/api/method/oidc_extended.callback.custom/keycloak-{realm_id}
```

**Ù…Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ø²Ù„:**
- ÙƒÙ„ Client Secret ÙØ±ÙŠØ¯ Ù„ÙƒÙ„ Ø§Ø´ØªØ±Ø§Ùƒ
- Ø§Ù„Ù…Ù†ØªØ¬ ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„ÙˆØµÙˆÙ„ **ÙÙ‚Ø·** Ù„Ù„Ù€ Realm Ø§Ù„Ø°ÙŠ ÙŠÙ…ØªÙ„Ùƒ Client ÙÙŠÙ‡
- Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ù†ØªØ¬ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù€ Realms Ø£Ø®Ø±Ù‰ Ø­ØªÙ‰ Ù„Ùˆ Ø­ØµÙ„ Ø¹Ù„Ù‰ Client Secret
- Kayan ERP ÙŠØ³ØªØ®Ø¯Ù… **Ù…ÙˆÙ‚Ø¹ Ù…Ø¹Ø²ÙˆÙ„ ØªÙ…Ø§Ù…Ø§Ù‹** Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†ÙØµÙ„Ø©

---

## ğŸ” Ø¢Ù„ÙŠØ© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©

### 1. Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…ØªØ¬Ø± Ù…Ø¹ Keycloak

**Ø§Ù„Ù…Ù„Ù:** `/app/Services/KeycloakService.php`

```php
class KeycloakService
{
    protected $serviceClientId;
    protected $serviceClientSecret;
    protected $accessToken;

    public function __construct()
    {
        $this->baseUrl = config('services.keycloak.url');
        $this->serviceClientId = config('services.keycloak.service_account.client_id');
        $this->serviceClientSecret = config('services.keycloak.service_account.client_secret');
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Access Token Ù…Ù† Keycloak
     * ÙŠØ³ØªØ®Ø¯Ù… OAuth 2.0 Client Credentials Flow
     */
    protected function getAdminToken($forceRefresh = false)
    {
        if ($forceRefresh) {
            $this->accessToken = null;
        }

        if ($this->accessToken) {
            return $this->accessToken;
        }

        $response = $this->client->post('/realms/master/protocol/openid-connect/token', [
            'form_params' => [
                'grant_type' => 'client_credentials',
                'client_id' => $this->serviceClientId,
                'client_secret' => $this->serviceClientSecret,
            ],
        ]);

        $data = json_decode($response->getBody()->getContents(), true);
        $this->accessToken = $data['access_token'];

        return $this->accessToken;
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Token (ÙŠÙØ³ØªØ¯Ø¹Ù‰ Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Realm Ø£Ùˆ Client)
     * Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹: Keycloak ÙŠØ®Ø²Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Realms ÙÙŠ Ø§Ù„Ù€ token
     */
    protected function refreshToken()
    {
        return $this->getAdminToken(true);
    }
}
```

---

### 2. Ù…ØµØ§Ø¯Ù‚Ø© Training/Services Platform Ù…Ø¹ Keycloak

**Ø§Ù„Ù…Ù„Ù:** `/training-platform/app/Services/KeycloakAdminService.php`

```php
class KeycloakAdminService
{
    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Access Token Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Client Credentials
     * ÙŠØ³ØªØ®Ø¯Ù… client_secret Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù€ Tenant
     */
    protected function getTenantToken($realmId, $clientId, $clientSecret)
    {
        $response = $this->client->post("/realms/{$realmId}/protocol/openid-connect/token", [
            'form_params' => [
                'client_id' => $clientId,
                'client_secret' => decrypt($clientSecret),  // ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±
                'grant_type' => 'client_credentials',
            ],
        ]);

        $data = json_decode($response->getBody()->getContents(), true);
        return $data['access_token'];
    }
}
```

---

### 3. Ù…ØµØ§Ø¯Ù‚Ø© Kayan ERP Ù…Ø¹ Keycloak

#### 3.1. Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (OIDC Standard Flow):

**Ø§Ù„Ù…Ù„Ù:** `/kayan-erp/apps/oidc_extended/oidc_extended/login.py`

```python
# Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙØ¹Ø§Ø¯ ØªÙˆØ¬ÙŠÙ‡Ù‡ Ø¥Ù„Ù‰ Keycloak Ù„Ù„Ù…ØµØ§Ø¯Ù‚Ø©
authorization_url = f"{keycloak_url}/realms/{realm_id}/protocol/openid-connect/auth"
params = {
    "client_id": client_id,
    "redirect_uri": redirect_uri,
    "response_type": "code",
    "scope": "openid profile email"
}

# Ø¨Ø¹Ø¯ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©ØŒ Keycloak ÙŠÙØ¹ÙŠØ¯ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù…Ø¹ authorization code
# Ø«Ù… Ù†Ø³ØªØ¨Ø¯Ù„Ù‡ Ø¨Ù€ access_token
```

#### 3.2. Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø± (Client Credentials):

**Ø§Ù„Ù…Ù„Ù:** `/kayan-erp/apps/oidc_extended/oidc_extended/sync.py`

```python
def get_client_credentials_token(realm_id, client_id, client_secret, keycloak_url):
    """
    Get access token using OAuth 2.0 Client Credentials flow
    Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¢Ù…Ù†Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© - Ù„Ø§ ØªØ­ØªØ§Ø¬ Ù„Ù€ admin credentials
    """
    response = requests.post(
        f"{keycloak_url}/realms/{realm_id}/protocol/openid-connect/token",
        data={
            "grant_type": "client_credentials",
            "client_id": client_id,
            "client_secret": client_secret,
        },
        timeout=10
    )

    if response.status_code == 200:
        return response.json()['access_token']
    else:
        frappe.logger().error(f"Failed to get token: {response.status_code}")
        return None

def sync_roles_with_client_credentials(realm_id, client_id, client_secret, keycloak_url, roles):
    """
    Ù…Ø²Ø§Ù…Ù†Ø© Ø£Ø¯ÙˆØ§Ø± Frappe Ø¥Ù„Ù‰ Keycloak Groups Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… client credentials
    Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ø¢Ù…Ù†Ø© - ØªØ³ØªØ®Ø¯Ù… token Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù€ product
    """
    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ access token
    access_token = get_client_credentials_token(realm_id, client_id, client_secret, keycloak_url)

    if not access_token:
        return {"success": False, "message": "Failed to get access token"}

    synced_count = 0

    # Ø¥Ù†Ø´Ø§Ø¡ group Ù„ÙƒÙ„ role
    for role_name in roles:
        group_data = {
            "name": role_name,
            "attributes": {
                "source": ["frappe"],
                "auto_synced": ["true"],
                "synced_via": ["client_credentials"]
            }
        }

        response = requests.post(
            f"{keycloak_url}/admin/realms/{realm_id}/groups",
            headers={
                "Authorization": f"Bearer {access_token}",
                "Content-Type": "application/json"
            },
            json=group_data,
            timeout=10
        )

        if response.status_code in [201, 409]:  # Created or already exists
            synced_count += 1

    return {
        "success": True,
        "message": f"Successfully synced {synced_count} roles",
        "synced_count": synced_count
    }
```

---

## ğŸ”‘ Ø¶Ø¨Ø· Social Login Key ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„

### ÙÙŠ Ù…Ù†ØªØ¬Ø§Øª Laravel (Training & Services)

#### 1. Ø§Ø³ØªÙ„Ø§Ù… Client Credentials Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±

Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ±Ø³Ù„ Ø§Ù„Ù…ØªØ¬Ø± Webhook Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬ØŒ ÙŠØªÙ… Ø­ÙØ¸ Client Credentials ÙÙŠ Ø¬Ø¯ÙˆÙ„ `tenants`:

```php
// /training-platform/app/Http/Controllers/Api/KeycloakWebhookController.php

public function setup(Request $request)
{
    // 1. Ø¥ÙŠØ¬Ø§Ø¯ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Tenant
    $tenant = Tenant::where('id', $request->tenant_id)->first();

    if (!$tenant) {
        $tenant = Tenant::create(['id' => $request->tenant_id]);
        $tenant->domains()->create(['domain' => $request->domain]);
    }

    // 2. Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Keycloak ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    $tenant->update([
        'keycloak_realm' => $request->realm_id,           // tenant-89796
        'keycloak_client_id' => $request->client_id,       // training-platform
        'keycloak_client_secret' => encrypt($request->client_secret), // Ù…Ø´ÙÙ‘Ø±
        'keycloak_configured' => true,  // Ø¹Ù„Ø§Ù…Ø© ØªÙØ¹ÙŠÙ„ SSO
    ]);

    // 3. ØªÙØ¹ÙŠÙ„ Ø³ÙŠØ§Ù‚ Tenant Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
    tenancy()->initialize($tenant);

    // 4. Ù…Ø²Ø§Ù…Ù†Ø© Ø£Ø¯ÙˆØ§Ø± Laravel Ø¥Ù„Ù‰ Keycloak Groups
    $this->syncRolesToKeycloak($tenant, app(KeycloakAdminService::class));

    return response()->json(['success' => true]);
}
```

#### 2. Ø¸Ù‡ÙˆØ± Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Keycloak SSO

**Ø§Ù„Ù…Ù„Ù:** `/training-platform/resources/views/filament/pages/auth/login.blade.php`

```blade
{{-- Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ --}}
<x-filament-panels::form wire:submit="authenticate">
    {{ $this->form }}
    <!-- Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©: email, password -->
</x-filament-panels::form>

{{-- Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Keycloak SSO --}}
@if(tenancy()->tenant?->keycloak_configured)
    <div class="mt-6">
        <div class="relative">
            <div class="absolute inset-0 flex items-center">
                <div class="w-full border-t border-gray-300"></div>
            </div>
            <div class="relative flex justify-center text-sm">
                <span class="px-2 bg-white text-gray-500">
                    {{ __('Or continue with') }}
                </span>
            </div>
        </div>

        <div class="mt-6">
            <form action="{{ route('keycloak.redirect') }}" method="GET">
                <button type="submit" class="w-full inline-flex justify-center items-center px-4 py-2 border rounded-lg shadow-sm">
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
                        <path d="M11.5 0L0 6v7.5C0 19.8 5 24 11.5 24..."/>
                    </svg>
                    {{ __('Sign in with Keycloak SSO') }}
                </button>
            </form>
        </div>
    </div>
@endif
```

**Ø§Ù„Ø´Ø±Ø· Ø§Ù„Ù…Ù‡Ù…:**
- Ø§Ù„Ø²Ø± ÙŠØ¸Ù‡Ø± **ÙÙ‚Ø·** Ø¥Ø°Ø§ ÙƒØ§Ù† `keycloak_configured = true`
- ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Webhook Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±

#### 3. Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø¯ÙˆØ§Ø±

**Ø§Ù„Ù…Ù„Ù:** `/training-platform/app/Http/Controllers/Auth/KeycloakController.php`

```php
public function redirect()
{
    $tenant = tenancy()->tenant;

    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Keycloak Ù„Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    $authUrl = "{$keycloakUrl}/realms/{$tenant->keycloak_realm}/protocol/openid-connect/auth?" . http_build_query([
        'client_id' => $tenant->keycloak_client_id,
        'redirect_uri' => url('/auth/keycloak/callback'),
        'response_type' => 'code',
        'scope' => 'openid profile email',  // Groups ØªÙØ¶Ù…Ù‘Ù† ÙÙŠ Token
    ]);

    return redirect($authUrl);
}

public function callback(Request $request)
{
    $tenant = tenancy()->tenant;

    // 1. Ø§Ø³ØªØ¨Ø¯Ø§Ù„ authorization code Ø¨Ù€ access token
    $tokenResponse = Http::asForm()->post("{$keycloakUrl}/realms/{$tenant->keycloak_realm}/protocol/openid-connect/token", [
        'grant_type' => 'authorization_code',
        'client_id' => $tenant->keycloak_client_id,
        'client_secret' => decrypt($tenant->keycloak_client_secret),
        'code' => $request->code,
        'redirect_uri' => url('/auth/keycloak/callback'),
    ]);

    $accessToken = $tokenResponse->json()['access_token'];

    // 2. ÙÙƒ ØªØ´ÙÙŠØ± JWT Token Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Groups
    $tokenParts = explode('.', $accessToken);
    $payload = json_decode(base64_decode($tokenParts[1]), true);

    // 3. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    $userInfo = Http::withToken($accessToken)->get("{$keycloakUrl}/realms/{$tenant->keycloak_realm}/protocol/openid-connect/userinfo")->json();

    // 4. Ø¥ÙŠØ¬Ø§Ø¯ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Laravel
    $user = User::updateOrCreate(
        ['email' => $userInfo['email']],
        [
            'name' => $userInfo['name'],
            'email' => $userInfo['email'],
            'password' => bcrypt(Str::random(32)), // ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
            'email_verified_at' => now(),
        ]
    );

    // 5. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Groups Ù…Ù† Token
    $groups = $payload['groups'] ?? [];  // Ù…Ø«Ø§Ù„: ["super_admin", "editor"]

    // 6. Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø±: ØªØ¹ÙŠÙŠÙ† Groups ÙƒÙ€ Roles ÙÙŠ Laravel
    $this->syncRoles($user, $groups);

    // 7. ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    Auth::login($user, true);

    return redirect('/admin');
}

/**
 * Ù…Ø²Ø§Ù…Ù†Ø© Groups Ù…Ù† Keycloak Ø¥Ù„Ù‰ Roles ÙÙŠ Laravel
 */
protected function syncRoles(User $user, array $groups)
{
    // ØªØ¹ÙŠÙŠÙ† team_id Ù„Ù„Ù€ Multi-tenancy
    app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($tenant->id);

    $roleNames = [];
    foreach ($groups as $group) {
        $roleNames[] = is_array($group) ? $group['name'] : $group;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Laravel
    $existingRoles = \Spatie\Permission\Models\Role::pluck('name')->toArray();

    // ØªØ¹ÙŠÙŠÙ† ÙÙ‚Ø· Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    $validRoleNames = array_intersect($roleNames, $existingRoles);

    // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø± (Ø­Ø°Ù Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
    $user->syncRoles($validRoleNames);

    Log::info("Roles synced for user", [
        'email' => $user->email,
        'keycloak_groups' => $groups,
        'assigned_roles' => $validRoleNames,
    ]);
}
```

### Ø¢Ù„ÙŠØ© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø¯ÙˆØ§Ø± (Role Assignment Flow)

```
1. Ø§Ù„Ù…ØªØ¬Ø± ÙŠÙ†Ø´Ø¦ Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹ ÙÙŠ Keycloak Realm
         â†“
2. Ø§Ù„Ù…ØªØ¬Ø± ÙŠØ¹ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù€ Group (Ù…Ø«Ù„Ø§Ù‹: "super_admin")
         â†“
3. Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¶ØºØ· "Sign in with Keycloak SSO" ÙÙŠ Ù…Ù†ØªØ¬ Training
         â†“
4. Keycloak ÙŠÙØµØ¯Ø± JWT Token ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰:
    - email
    - name
    - groups: ["super_admin", "editor"]  â† Ø¹Ø¨Ø± Group Mapper
         â†“
5. KeycloakController ÙŠÙ‚Ø±Ø£ groups Ù…Ù† Token
         â†“
6. KeycloakController ÙŠØ¨Ø­Ø« Ø¹Ù† Roles ÙÙŠ Laravel Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù…
         â†“
7. KeycloakController ÙŠØ¹ÙŠÙ† Roles Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: $user->syncRoles(["super_admin"])
         â†“
8. Laravel ÙŠØ·Ø¨Ù‚ Permissions Ø­Ø³Ø¨ Ø§Ù„Ù€ Role
```

### ÙÙŠ Ù…Ù†ØªØ¬ Kayan ERP (Frappe)

#### 1. Ø¶Ø¨Ø· Social Login Key ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹

**Ø§Ù„Ù…Ù„Ù:** `/kayan-erp/apps/oidc_extended/oidc_extended/setup.py`

```python
def configure_keycloak(realm_id, client_id, client_secret, keycloak_url, ...):
    """
    Ø¥Ù†Ø´Ø§Ø¡ Social Login Key ÙÙŠ Frappe Ù„ØªÙ…ÙƒÙŠÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Keycloak
    """
    # 1. Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Social Login Key
    key_name = f"keycloak-{realm_id}"

    if frappe.db.exists("Social Login Key", key_name):
        social_key = frappe.get_doc("Social Login Key", key_name)
    else:
        social_key = frappe.new_doc("Social Login Key")
        social_key.name = key_name

    # 2. Ø¶Ø¨Ø· Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    social_key.provider_name = "Keycloak"
    social_key.enable_social_login = 1  # â† ØªÙØ¹ÙŠÙ„ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    social_key.client_id = client_id
    social_key.client_secret = client_secret
    social_key.base_url = keycloak_url
    social_key.authorize_url = f"{keycloak_url}/realms/{realm_id}/protocol/openid-connect/auth"
    social_key.access_token_url = f"{keycloak_url}/realms/{realm_id}/protocol/openid-connect/token"
    social_key.redirect_url = f"{frappe.utils.get_url()}/api/method/frappe.integrations.oauth2_logins.custom/keycloak-{realm_id}"

    social_key.save(ignore_permissions=True)
    frappe.db.commit()

    return social_key.name
```

#### 2. Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ù…Ù† Frappe Ø¥Ù„Ù‰ Keycloak

**Ø¹Ù†Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Webhook:**

```python
@frappe.whitelist(allow_guest=True)
def keycloak_webhook_setup(**kwargs):
    # 1. Ø­ÙØ¸ Client Credentials
    # 2. Ø¶Ø¨Ø· Social Login Key (Ø£Ø¹Ù„Ø§Ù‡)

    # 3. Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø£Ø¯ÙˆØ§Ø± Frappe
    roles = frappe.get_all("Role", filters={"disabled": 0}, pluck="name")
    # Ù…Ø«Ø§Ù„: ["System Manager", "Sales User", "HR Manager", ...]

    # 4. Ù…Ø²Ø§Ù…Ù†Ø© ÙƒÙ„ Ø¯ÙˆØ± Ø¥Ù„Ù‰ Keycloak ÙƒÙ€ Group
    from oidc_extended.sync import sync_roles_with_client_credentials

    result = sync_roles_with_client_credentials(
        realm_id=realm_id,
        client_id=client_id,
        client_secret=client_secret,
        keycloak_url=keycloak_url,
        roles=roles  # 49 Ø¯ÙˆØ±
    )

    # Ù†ØªÙŠØ¬Ø©: 49 Group ÙÙŠ Keycloak Realm
```

#### 3. ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„

**Ø§Ù„Ù…Ù„Ù:** `/kayan-erp/apps/oidc_extended/oidc_extended/callback.py`

```python
def handle_keycloak_callback(code, state):
    """
    Ù…Ø¹Ø§Ù„Ø¬Ø© Callback Ù…Ù† Keycloak ÙˆØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
    """
    # 1. Ø§Ø³ØªØ¨Ø¯Ø§Ù„ code Ø¨Ù€ access_token
    token_response = requests.post(token_url, data={
        'grant_type': 'authorization_code',
        'client_id': client_id,
        'client_secret': client_secret,
        'code': code,
        'redirect_uri': redirect_uri,
    })

    access_token = token_response.json()['access_token']

    # 2. ÙÙƒ ØªØ´ÙÙŠØ± JWT Token
    payload = jwt.decode(access_token, options={"verify_signature": False})

    # 3. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Groups Ù…Ù† Token
    groups = payload.get('groups', [])  # ["System Manager", "Sales User"]

    # 4. Ø¥ÙŠØ¬Ø§Ø¯ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Frappe
    user_email = payload.get('email')
    if not frappe.db.exists("User", user_email):
        user = frappe.get_doc({
            "doctype": "User",
            "email": user_email,
            "first_name": payload.get('given_name'),
            "last_name": payload.get('family_name'),
        })
        user.insert(ignore_permissions=True)
    else:
        user = frappe.get_doc("User", user_email)

    # 5. Ù…Ø²Ø§Ù…Ù†Ø© Groups Ø¥Ù„Ù‰ Roles ÙÙŠ Frappe
    sync_user_roles(user, groups)

    # 6. ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    frappe.local.login_manager.login_as(user_email)

    return user

def sync_user_roles(user, groups):
    """
    ØªØ¹ÙŠÙŠÙ† Groups Ù…Ù† Keycloak ÙƒÙ€ Roles ÙÙŠ Frappe
    """
    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Frappe
    existing_roles = frappe.get_all("Role", filters={"disabled": 0}, pluck="name")

    # ØªØµÙÙŠØ© Groups Ù„Ù„Ø§Ø­ØªÙØ§Ø¸ ÙÙ‚Ø· Ø¨Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    valid_roles = [g for g in groups if g in existing_roles]

    # Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    user.roles = []

    # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    for role_name in valid_roles:
        user.append("roles", {"role": role_name})

    user.save(ignore_permissions=True)
    frappe.db.commit()

    frappe.logger().info(f"Synced roles for {user.email}: {valid_roles}")
```

### Ù…Ù„Ø®Øµ Ø¢Ù„ÙŠØ© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø¯ÙˆØ§Ø±

| Ø§Ù„Ø®Ø·ÙˆØ© | Ø§Ù„Ù…ØªØ¬Ø± | Ø§Ù„Ù…Ù†ØªØ¬ (Laravel) | Ø§Ù„Ù…Ù†ØªØ¬ (Frappe) |
|--------|--------|-----------------|-----------------|
| 1 | ÙŠÙ†Ø´Ø¦ User ÙÙŠ Keycloak | - | - |
| 2 | ÙŠØ¹ÙŠÙ† User Ù„Ù€ Groups | - | - |
| 3 | - | ÙŠØ­ÙØ¸ Client Credentials ÙÙŠ DB | ÙŠØ­ÙØ¸ ÙÙŠ Social Login Key |
| 4 | - | ÙŠØ²Ø§Ù…Ù† Roles â†’ Keycloak Groups | ÙŠØ²Ø§Ù…Ù† Roles â†’ Keycloak Groups |
| 5 | - | User ÙŠØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± SSO | User ÙŠØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± SSO |
| 6 | - | Token ÙŠØ­ØªÙˆÙŠ Groups | Token ÙŠØ­ØªÙˆÙŠ Groups |
| 7 | - | ÙŠÙ‚Ø±Ø£ Groups ÙˆÙŠØ¹ÙŠÙ† Roles | ÙŠÙ‚Ø±Ø£ Groups ÙˆÙŠØ¹ÙŠÙ† Roles |
| 8 | - | Laravel ÙŠØ·Ø¨Ù‚ Permissions | Frappe ÙŠØ·Ø¨Ù‚ Permissions |

**Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ù‡Ù…Ø©:**
- âœ… Ø§Ù„Ù…ØªØ¬Ø± ÙŠÙØ¯ÙŠØ± Users Ùˆ Groups ÙÙŠ Keycloak
- âœ… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØªÙØ²Ø§Ù…Ù† Roles Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø§ Ø¥Ù„Ù‰ Keycloak ÙƒÙ€ Groups
- âœ… Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø§Ù„Ù…Ù†ØªØ¬ ÙŠÙ‚Ø±Ø£ Groups Ù…Ù† Token ÙˆÙŠØ¹ÙŠÙ†Ù‡Ø§ ÙƒÙ€ Roles Ù…Ø­Ù„ÙŠØ©
- âœ… **Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ø§ ÙŠÙÙ†Ø´Ø¦ Groups** - ÙÙ‚Ø· ÙŠØ²Ø§Ù…Ù† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ø¯ÙŠÙ‡
- âœ… **Ø§Ù„Ù…ØªØ¬Ø± Ù‡Ùˆ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„ÙˆØ­ÙŠØ¯** Ø¹Ù† ØªØ¹ÙŠÙŠÙ† Users Ø¥Ù„Ù‰ Groups

---

## ğŸ”„ Ø¯ÙˆØ±Ø© Ø­ÙŠØ§Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ

### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø±

```
Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙØ³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø±
         â†“
UserObserver::created()
         â†“
dispatch(CreateUserKeycloakRealm)  â† Queue Job
         â†“
KeycloakService::createTenantRealm()
         â†“
Keycloak: Ø¥Ù†Ø´Ø§Ø¡ Realm (tenant-{user_id})
         â†“
Ø­ÙØ¸ keycloak_realm_id ÙÙŠ Ø¬Ø¯ÙˆÙ„ users
```

**Ø§Ù„Ù…Ù„Ù:** `/app/Jobs/CreateUserKeycloakRealm.php`

```php
public function handle()
{
    $keycloak = app(KeycloakService::class);

    // 1. Ø¥Ù†Ø´Ø§Ø¡ Realm Ø¬Ø¯ÙŠØ¯
    $realmId = "tenant-{$this->user->id}";
    $keycloak->createTenantRealm($realmId, $this->user->company_name);

    // 2. ØªØ­Ø¯ÙŠØ« Token Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù€ Realm Ø§Ù„Ø¬Ø¯ÙŠØ¯
    $keycloak->refreshToken();

    // 3. ØªØ«Ø¨ÙŠØª Admin Console Client
    $keycloak->fixAdminConsoleClient($realmId);

    // 4. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Keycloak ÙˆØªØ¹ÙŠÙŠÙ† Ø¯ÙˆØ± realm-admin
    $keycloak->createUser($realmId, [/* ... */]);
    $keycloak->assignRealmAdminRole($realmId, $this->user->email);

    // 5. Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Keycloak ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    $this->user->update([
        'keycloak_realm_id' => $realmId,
    ]);

    Log::info("Successfully created Keycloak realm {$realmId} for user {$this->user->id}");
}
```

---

### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Training Ø£Ùˆ Services

```
Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¶ØºØ· "Ø§Ø´ØªØ±Ø§Ùƒ" ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø±
         â†“
SubscriptionController::subscribe('training')
         â†“
Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Product API: POST /api/tenants/create
         â†“
Ø§Ù„Ù…Ù†ØªØ¬ ÙŠÙ†Ø´Ø¦ Tenant ÙˆÙŠÙØ±Ø¬Ø¹ (tenant_id, domain)
         â†“
Ø­ÙØ¸ Subscription ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    - status: 'active'  â† Ù…Ù‡Ù…!
    - is_active: true
         â†“
Event: SubscriptionCreated (Ø¨Ø¹Ø¯ DB::afterCommit)
         â†“
Listener: CreateKeycloakRealm::handle()
         â†“
KeycloakService::createProductClient()
    - Ø¥Ù†Ø´Ø§Ø¡ Client ÙÙŠ Keycloak
    - ØªÙˆÙ„ÙŠØ¯ Client Secret
    - Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ§Øª realm-management
    - Ø¥Ø¶Ø§ÙØ© Group Mapper
         â†“
Ø­ÙØ¸ client_id, client_secret ÙÙŠ Subscription
         â†“
Ø¥Ø±Ø³Ø§Ù„ Webhook Ù„Ù„Ù…Ù†ØªØ¬: POST /api/keycloak/setup
         â†“
Ø§Ù„Ù…Ù†ØªØ¬ ÙŠØ³ØªÙ„Ù…:
    - realm_id
    - client_id
    - client_secret
    - tenant_id
    - domain
         â†“
Ø§Ù„Ù…Ù†ØªØ¬ ÙŠØ­ÙØ¸ Client Secret (Ù…Ø´ÙÙ‘Ø±)
         â†“
Ø§Ù„Ù…Ù†ØªØ¬ ÙŠØ²Ø§Ù…Ù† Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ù…Ø¹ Keycloak
```

**Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:**

```php
// app/Http/Controllers/SubscriptionController.php

private function subscribeTraining($user)
{
    // 1. Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Training API
    $response = Http::post('http://localhost:5000/api/tenants/create', [
        'user_id' => $user->id,
        'company_name' => $user->company_name,
        'email' => $user->email,
    ]);

    $data = $response->json();

    // 2. Ø­ÙØ¸ Subscription Ù…Ø¹ status = 'active'
    return Subscription::create([
        'user_id' => $user->id,
        'product' => 'training',
        'tenant_id' => $data['tenant_id'],
        'domain' => $data['domain'],
        'url' => $data['admin_url'],
        'is_active' => true,
        'status' => 'active',  // 
        'meta' => [/* ... */],
    ]);

    // 3. Event SubscriptionCreated ÙŠÙØ·Ù„Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ø¨Ø± Model::boot()
}
```

---

### Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Kayan ERP (Ø¹Ù…Ù„ÙŠØ© Ø®Ø§ØµØ©)

```
Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¶ØºØ· "Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Kayan ERP"
         â†“
SubscriptionController::subscribeKayanERP()
         â†“
Ø­ÙØ¸ Subscription:
    - status: 'pending'  â† ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    - is_active: false
    - url: null
    - domain: null
         â†“
dispatch(CreateKayanERPSite)  â† Queue Job
         â†“
Job ÙŠØ³ØªØ¯Ø¹Ù‰ Python Script:
    /kayan-erp/scripts/create_tenant_site.py
         â†“
Python Script ÙŠÙ†Ø´Ø¦:
    âœ“ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†ÙØµÙ„Ø©: kayan-user-{id}
    âœ“ Ù…ÙˆÙ‚Ø¹ Frappe Ù…Ø¹Ø²ÙˆÙ„
    âœ“ Ù…Ù†ÙØ° Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ: 40XXX
    âœ“ domain: kayan-user-{id}.local
         â†“
Job ÙŠØ­Ø¯Ù‘Ø« Subscription:
    - tenant_id: kayan-user-{id}
    - domain: kayan-user-{id}.local
    - url: http://localhost:40XXX
    - status: 'active'  â† Ø§Ù„Ø¢Ù† Ø£ØµØ¨Ø­ Ù†Ø´Ø·Ø§Ù‹
    - is_active: true
         â†“
Job ÙŠÙØ·Ù„Ù‚ Event: SubscriptionCreated (Ù…Ø±Ø© Ø£Ø®Ø±Ù‰)
         â†“
Listener: CreateKeycloakRealm::handle()
    - ÙŠØªØ­Ù‚Ù‚: Ù‡Ù„ url Ù…ÙˆØ¬ÙˆØ¯ØŸ Ù†Ø¹Ù… âœ“
    - ÙŠÙ†Ø´Ø¦ Client ÙÙŠ Keycloak
    - redirect_uri: http://localhost:40XXX/*
         â†“
Listener ÙŠØ±Ø³Ù„ Webhook:
    POST http://localhost:40XXX/api/method/oidc_extended.setup.keycloak_webhook_setup
         â†“
Frappe ÙŠØ³ØªÙ„Ù… Webhook ÙˆÙŠØ¹Ø§Ù„Ø¬Ù‡:
    1. ÙŠØ­ÙØ¸ client_id, client_secret ÙÙŠ site_config.json
    2. ÙŠÙ†Ø´Ø¦ Social Login Key
    3. ÙŠÙ†Ø´Ø¦ OIDC Extended Configuration
    4. ÙŠØ²Ø§Ù…Ù† 49 Ø¯ÙˆØ± Frappe Ø¥Ù„Ù‰ Keycloak Groups
    5. ÙŠÙ†Ø´Ø¦ group-role mappings
```

**Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ:**

```php
// app/Http/Controllers/SubscriptionController.php

private function subscribeKayanERP($user)
{
    $adminPassword = 'admin' . rand(1000, 9999);

    // 1. Ø¥Ù†Ø´Ø§Ø¡ Subscription Ø¨Ø­Ø§Ù„Ø© pending
    $subscription = Subscription::create([
        'user_id' => $user->id,
        'product' => 'kayan_erp',
        'tenant_id' => null,      // Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
        'domain' => null,          // Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
        'url' => null,             // Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
        'is_active' => false,      // Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
        'status' => 'pending',     // ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
        'meta' => [
            'admin_password' => $adminPassword,
        ],
    ]);

    // 2. Ø¥Ø·Ù„Ø§Ù‚ Job Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    dispatch(new CreateKayanERPSite($subscription, $user, $adminPassword));

    return $subscription;
}
```

```php
// app/Jobs/CreateKayanERPSite.php

public function handle(): void
{
    // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ processing
    $this->subscription->update(['status' => 'processing']);

    // 2. Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Python Script Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    $scriptPath = '/home/vboxuser/kayan-erp/scripts/create_tenant_site.py';
    $command = sprintf(
        'python3 %s %d %s %s %s',
        escapeshellarg($scriptPath),
        $this->user->id,
        escapeshellarg($this->user->company_name),
        escapeshellarg($this->user->email),
        escapeshellarg($this->adminPassword)
    );

    exec($command, $output, $returnCode);
    $result = json_decode(implode("\n", $output), true);

    if (!$result || !$result['success']) {
        throw new \Exception($result['message'] ?? 'Failed to create site');
    }

    // 3. ØªØ­Ø¯ÙŠØ« Subscription Ø¨Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹
    $this->subscription->update([
        'tenant_id' => $result['site_name'],    // kayan-user-123
        'domain' => $result['domain'],           // kayan-user-123.local
        'url' => $result['url'],                 // http://localhost:40896
        'status' => 'active',                    // Ø§Ù„Ø¢Ù† Ù†Ø´Ø·!
        'is_active' => true,
        'meta' => json_encode([
            'site_name' => $result['site_name'],
            'admin_password' => $this->adminPassword,
            'port' => $result['port'],
        ]),
    ]);

    // 4. Ø¥Ø·Ù„Ø§Ù‚ Event Ù„Ø¥Ù†Ø´Ø§Ø¡ Keycloak Client
    $this->subscription->refresh();
    event(new \App\Events\SubscriptionCreated($this->subscription, $this->user));
}
```

```php
// app/Listeners/CreateKeycloakRealm.php

public function handle(SubscriptionCreated $event): void
{
    $subscription = $event->subscription;
    $user = $event->user;

    // Ù„Ù„Ù…Ù†ØªØ¬ Kayan ERP: ØªØ®Ø·ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯
    if ($subscription->product === 'kayan_erp' && empty($subscription->url)) {
        Log::info("Skipping Keycloak client - site not created yet");
        return;  // Ø³ÙŠÙ†ÙØ° Event Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    }

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… URL Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù„Ù€ Kayan ERP
    $productUrl = $subscription->product === 'kayan_erp' && $subscription->url
        ? $subscription->url
        : $productConfig['url'];

    // Ø¥Ù†Ø´Ø§Ø¡ Client ÙÙŠ Keycloak
    $clientData = $this->keycloak->createProductClient(
        $user->keycloak_realm_id,
        'kayan-erp',
        $productUrl,  // http://localhost:40896
        $subscription->domain
    );

    // Ø¥Ø±Ø³Ø§Ù„ Webhook Ù„Ù„Ù…ÙˆÙ‚Ø¹
    $webhookUrl = $subscription->url . '/api/method/oidc_extended.setup.keycloak_webhook_setup';
    Http::post($webhookUrl, [
        'realm_id' => $user->keycloak_realm_id,
        'client_id' => $clientData['client_id'],
        'client_secret' => $clientData['client_secret'],
        // ...
    ]);
}
```

```python
# /kayan-erp/apps/oidc_extended/oidc_extended/setup.py

@frappe.whitelist(allow_guest=True)
def keycloak_webhook_setup(**kwargs):
    """
    Webhook endpoint Ù…Ù† Laravel Marketplace
    ÙŠØ³ØªÙ‚Ø¨Ù„ client credentials ÙˆÙŠØ¶Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹
    """
    data = frappe._dict(kwargs)

    realm_id = data.realm_id
    client_id = data.client_id
    client_secret = data.client_secret
    keycloak_base_url = data.get('realm_url', '').replace(f"/realms/{realm_id}", "")

    # 1. Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Keycloak ÙÙŠ Social Login Key
    configure_keycloak(
        realm_id=realm_id,
        client_id=client_id,
        client_secret=client_secret,
        keycloak_url=keycloak_base_url,
        # ...
    )

    # 2. Ø­ÙØ¸ Client Credentials ÙÙŠ site_config.json
    from frappe.installer import update_site_config
    update_site_config("keycloak_realm_id", realm_id)
    update_site_config("keycloak_client_id", client_id)
    update_site_config("keycloak_client_secret", client_secret)
    update_site_config("keycloak_url", keycloak_base_url)

    # 3. Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø£Ø¯ÙˆØ§Ø± Frappe
    roles_result = get_all_roles()
    roles = roles_result.get('roles', [])

    # 4. Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ù…Ø¹ Keycloak Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Client Credentials
    from oidc_extended.sync import sync_roles_with_client_credentials
    sync_result = sync_roles_with_client_credentials(
        realm_id=realm_id,
        client_id=client_id,
        client_secret=client_secret,
        keycloak_url=keycloak_base_url,
        roles=roles
    )

    # 5. Ø¥Ù†Ø´Ø§Ø¡ group-role mappings ÙÙŠ Frappe
    if sync_result.get('success'):
        mapping_result = sync_group_role_mappings(social_login_key_name, roles)

    return {
        "success": True,
        "roles_synced": sync_result.get('synced_count', 0),
        "mappings_created": mapping_result.get('mappings_created', 0)
    }
```

---

## ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª

### Ù…Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©

```
Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ (Roles/Permissions Table)
         â†“
Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ KeycloakAdminService Ø¨Ù€ Client Credentials
         â†“
Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¹ Keycloak (grant_type: client_credentials)
         â†“
Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Groups ÙÙŠ Keycloak Realm
         â†“
Groups ØªÙØ¶Ù…Ù‘Ù† ÙÙŠ JWT Token Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
         â†“
Ø§Ù„Ù…Ù†ØªØ¬ ÙŠÙ‚Ø±Ø£ Groups Ù…Ù† Token ÙˆÙŠØ·Ø¨Ù‚ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
```

### Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ ÙƒÙ„ Ù…Ù†ØªØ¬:

#### 1. Training/Services Platform:

```php
// Ø§Ù„Ù…Ù„Ù: /training-platform/app/Services/KeycloakAdminService.php

public function syncRolesToGroups($realmId, $roles)
{
    $tenant = app(\Stancl\Tenancy\Tenant::class);

    // Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Client Credentials Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù€ Tenant
    $token = $this->getTenantToken(
        $tenant->keycloak_realm,
        $tenant->keycloak_client_id,
        $tenant->keycloak_client_secret
    );

    foreach ($roles as $role) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Group
        $existingGroups = $this->getGroups($realmId);
        $existingGroup = collect($existingGroups)->firstWhere('name', $role['name']);

        if ($existingGroup) {
            // ØªØ­Ø¯ÙŠØ« Group Ù…ÙˆØ¬ÙˆØ¯
            $this->updateGroup($realmId, $existingGroup['id'], ['name' => $role['name']]);
        } else {
            // Ø¥Ù†Ø´Ø§Ø¡ Group Ø¬Ø¯ÙŠØ¯
            $this->createGroup($realmId, ['name' => $role['name']]);
        }
    }
}
```

#### 2. Kayan ERP (Frappe):

```python
# Ø§Ù„Ù…Ù„Ù: /kayan-erp/apps/oidc_extended/oidc_extended/sync.py

def sync_roles_with_client_credentials(realm_id, client_id, client_secret, keycloak_url, roles):
    """
    Ù…Ø²Ø§Ù…Ù†Ø© Ø£Ø¯ÙˆØ§Ø± Frappe Ø¥Ù„Ù‰ Keycloak Groups
    Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ø¢Ù…Ù†Ø© - ØªØ³ØªØ®Ø¯Ù… Client Credentials
    """
    # 1. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ access token
    access_token = get_client_credentials_token(
        realm_id, client_id, client_secret, keycloak_url
    )

    if not access_token:
        return {"success": False}

    synced_count = 0

    # 2. Ø¥Ù†Ø´Ø§Ø¡ group Ù„ÙƒÙ„ role
    for role_name in roles:
        group_data = {
            "name": role_name,
            "attributes": {
                "source": ["frappe"],
                "auto_synced": ["true"],
                "synced_via": ["client_credentials"]
            }
        }

        response = requests.post(
            f"{keycloak_url}/admin/realms/{realm_id}/groups",
            headers={
                "Authorization": f"Bearer {access_token}",
                "Content-Type": "application/json"
            },
            json=group_data
        )

        if response.status_code in [201, 409]:  # Created or exists
            synced_count += 1

    return {
        "success": True,
        "synced_count": synced_count
    }
```

---

## ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±

### ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©

Ø§Ù„Ù…ØªØ¬Ø± ÙŠÙˆÙØ± ÙˆØ§Ø¬Ù‡Ø© ÙƒØ§Ù…Ù„Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª **Ù…Ø¨Ø§Ø´Ø±Ø©** ÙÙŠ Keycloak Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù€ Admin Console:

**Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª:**
```
/users                     - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Realm
/users/create              - Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
/users/{id}/edit           - ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…
/users/{id}/reset-password - Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
/groups                    - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
/groups/{id}/members       - Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
```

### Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„Ø©:

#### 1. Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:

```php
// app/Http/Controllers/UserManagementController.php

public function index(Request $request)
{
    $user = Auth::user();

    // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Keycloak Ù…Ø¨Ø§Ø´Ø±Ø©
    $users = $this->keycloak->getUsers($user->keycloak_realm_id);

    return view('users.index', [
        'users' => $users,
        'realmId' => $user->keycloak_realm_id,
    ]);
}
```

#### 2. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯:

```php
public function store(Request $request)
{
    $validated = $request->validate([
        'username' => 'required|string|max:255',
        'email' => 'required|email|max:255',
        'first_name' => 'nullable|string|max:255',
        'last_name' => 'nullable|string|max:255',
        'password' => 'required|string|min:8',
        'enabled' => 'boolean',
        'groups' => 'nullable|array',  // ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
    ]);

    $user = Auth::user();

    // 1. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Keycloak
    $this->keycloak->createUser($user->keycloak_realm_id, [
        'username' => $request->username,
        'email' => $request->email,
        'first_name' => $request->first_name,  // firstName ÙÙŠ Keycloak
        'last_name' => $request->last_name,    // lastName ÙÙŠ Keycloak
        'password' => $request->password,
        'enabled' => $request->boolean('enabled', true),
        'email_verified' => $request->boolean('email_verified', false),
        'temporary_password' => $request->boolean('temporary_password', true),
    ]);

    // 2. ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§
    if ($request->has('groups') && is_array($request->groups)) {
        $users = $this->keycloak->getUsers($user->keycloak_realm_id);
        $newUser = collect($users)->firstWhere('username', $request->username);

        if ($newUser) {
            foreach ($request->groups as $groupId) {
                $this->keycloak->assignUserToGroup(
                    $user->keycloak_realm_id,
                    $newUser['id'],
                    $groupId
                );
            }
        }
    }

    return redirect()->route('users.index')
        ->with('success', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
}
```

**Ø¯Ø§Ù„Ø© createUser ÙÙŠ KeycloakService:**

```php
public function createUser($realmId, array $userData)
{
    $token = $this->getAdminToken();

    $response = $this->client->post("/admin/realms/{$realmId}/users", [
        'headers' => [
            'Authorization' => 'Bearer ' . $token,
            'Content-Type' => 'application/json',
        ],
        'json' => [
            'username' => $userData['username'],
            'email' => $userData['email'],
            'firstName' => $userData['first_name'] ?? '',  // camelCase Ù…Ù‡Ù…
            'lastName' => $userData['last_name'] ?? '',    // camelCase Ù…Ù‡Ù…
            'enabled' => $userData['enabled'] ?? true,
            'emailVerified' => $userData['email_verified'] ?? false,
            'credentials' => isset($userData['password']) ? [[
                'type' => 'password',
                'value' => $userData['password'],
                'temporary' => $userData['temporary_password'] ?? false,
            ]] : [],
        ],
    ]);

    Log::info("Created user {$userData['username']} in realm {$realmId}");
    return true;
}
```

#### 3. ØªØ¹ÙŠÙŠÙ† Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:

```php
public function assignGroup(Request $request, $userId)
{
    $validated = $request->validate([
        'group_id' => 'required|string',
    ]);

    $user = Auth::user();

    $this->keycloak->assignUserToGroup(
        $user->keycloak_realm_id,
        $userId,
        $validated['group_id']
    );

    return back()->with('success', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­');
}
```

**Ø¯Ø§Ù„Ø© assignUserToGroup:**

```php
public function assignUserToGroup($realmId, $userId, $groupId)
{
    $token = $this->getAdminToken();

    $this->client->put(
        "/admin/realms/{$realmId}/users/{$userId}/groups/{$groupId}",
        ['headers' => ['Authorization' => 'Bearer ' . $token]]
    );

    Log::info("Assigned user {$userId} to group {$groupId} in realm {$realmId}");
    return true;
}
```

---

## âš™ï¸ Queue Workers Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©

### Worker Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ù…ØªØ¬Ø±

**Ø§Ù„Ø£Ù…Ø±:**
```bash
php artisan queue:work --sleep=3 --tries=3 --timeout=900
```

**Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ§Øª:**
- Ù…Ø¹Ø§Ù„Ø¬Ø© `CreateUserKeycloakRealm` - Ø¥Ù†Ø´Ø§Ø¡ Realm Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
- Ù…Ø¹Ø§Ù„Ø¬Ø© `CreateKayanERPSite` - Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆÙ‚Ø¹ Frappe Ù…Ø¹Ø²ÙˆÙ„ (Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ 5-10 Ø¯Ù‚Ø§Ø¦Ù‚)

**Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©:**
- `timeout=900`: Ø¶Ø±ÙˆØ±ÙŠ Ù„Ø£Ù† Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆÙ‚Ø¹ Kayan ERP ÙŠØ³ØªØºØ±Ù‚ ÙˆÙ‚ØªØ§Ù‹ Ø·ÙˆÙŠÙ„Ø§Ù‹
- `tries=3`: ÙŠØ¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 3 Ù…Ø±Ø§Øª ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
- ÙŠØ¬Ø¨ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù€ Worker **Ø¨Ø§Ø³ØªÙ…Ø±Ø§Ø±** ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©

**ØªØ´ØºÙŠÙ„ ÙƒÙ€ Systemd Service (Ù„Ù„Ø¥Ù†ØªØ§Ø¬):**

```ini
# /etc/systemd/system/saas-queue-worker.service

[Unit]
Description=SaaS Marketplace Queue Worker
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/var/www/saas-marketplace
ExecStart=/usr/bin/php /var/www/saas-marketplace/artisan queue:work --sleep=3 --tries=3 --timeout=900
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**Ø§Ù„Ø£ÙˆØ§Ù…Ø±:**
```bash
sudo systemctl enable saas-queue-worker
sudo systemctl start saas-queue-worker
sudo systemctl status saas-queue-worker
```

---

### Worker Ù„Ù€ Kayan ERP Sites (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)

Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ worker Ù…Ù†ÙØµÙ„ Ù„Ù…ÙˆØ§Ù‚Ø¹ Kayan ERP:

```bash
php artisan queue:work --queue=kayan-erp --sleep=3 --tries=1 --timeout=1800
```

**Ø§Ù„ÙÙˆØ§Ø¦Ø¯:**
- Ø¹Ø²Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Kayan ERP Ø¹Ù† Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
- timeout Ø£Ø·ÙˆÙ„ (30 Ø¯Ù‚ÙŠÙ‚Ø©) Ù„Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
- `tries=1`: Ù„Ø§ ÙŠØ¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© (Ù„ØªØ¬Ù†Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆØ§Ù‚Ø¹ Ù…ÙƒØ±Ø±Ø©)

**ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Queue Ù…Ù†ÙØµÙ„:**

```php
// app/Http/Controllers/SubscriptionController.php

dispatch(new CreateKayanERPSite($subscription, $user, $adminPassword))
    ->onQueue('kayan-erp');  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ queue Ù…Ù†ÙØµÙ„
```

---

### Monitoring ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù€ Queue

#### 1. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù€ Jobs:

```bash
# Ø¹Ø±Ø¶ Jobs Ø§Ù„ÙØ§Ø´Ù„Ø©
php artisan queue:failed

# Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Job ÙØ§Ø´Ù„
php artisan queue:retry {job_id}

# Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Jobs Ø§Ù„ÙØ§Ø´Ù„Ø©
php artisan queue:retry all

# Ø­Ø°Ù Jobs Ø§Ù„ÙØ§Ø´Ù„Ø©
php artisan queue:flush
```

#### 2. Logs:

```bash
# Log Ø§Ù„Ù…ØªØ¬Ø±
tail -f /var/www/saas-marketplace/storage/logs/laravel.log

# Log Ø§Ù„Ù€ Queue Worker (Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù… systemd)
journalctl -u saas-queue-worker -f
```

#### 3. Horizon (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ù„Ù„Ø¥Ù†ØªØ§Ø¬):

```bash
composer require laravel/horizon
php artisan horizon:install
php artisan horizon
```

Horizon ÙŠÙˆÙØ±:
- ÙˆØ§Ø¬Ù‡Ø© ÙˆÙŠØ¨ Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù€ Queue
- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
- Ø¥Ø¯Ø§Ø±Ø© Jobs Ø§Ù„ÙØ§Ø´Ù„Ø©
- Auto-scaling Ù„Ù„Ù€ Workers

---

## ğŸ“š Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„Ø©

### ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø± (saas-marketplace):

#### Core Services:
- `/app/Services/KeycloakService.php` - Ø®Ø¯Ù…Ø© Keycloak Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  - `getAdminToken()` - Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¹ Keycloak
  - `createTenantRealm()` - Ø¥Ù†Ø´Ø§Ø¡ Realm
  - `createProductClient()` - Ø¥Ù†Ø´Ø§Ø¡ Client Ù„Ù„Ù…Ù†ØªØ¬
  - `grantProductClientPermissions()` - Ù…Ù†Ø­ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
  - `addGroupMapperToClient()` - Ø¥Ø¶Ø§ÙØ© Group Mapper

#### Event & Listeners:
- `/app/Events/SubscriptionCreated.php` - Event Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø´ØªØ±Ø§Ùƒ
- `/app/Listeners/CreateKeycloakRealm.php` - Ø¥Ù†Ø´Ø§Ø¡ Client ÙˆØ¥Ø±Ø³Ø§Ù„ Webhook

#### Jobs:
- `/app/Jobs/CreateUserKeycloakRealm.php` - Ø¥Ù†Ø´Ø§Ø¡ Realm Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…
- `/app/Jobs/CreateKayanERPSite.php` - Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆÙ‚Ø¹ Frappe Ù…Ø¹Ø²ÙˆÙ„

#### Controllers:
- `/app/Http/Controllers/SubscriptionController.php` - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª
- `/app/Http/Controllers/UserManagementController.php` - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
- `/app/Http/Controllers/GroupController.php` - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
- `/app/Http/Controllers/ProductController.php` - Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª

#### Models:
- `/app/Models/Subscription.php` - Model Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù…Ø¹ Event Boot
- `/app/Models/User.php` - Model Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
- `/app/Observers/UserObserver.php` - Observer Ù„Ø¥Ù†Ø´Ø§Ø¡ Realm ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹

#### Configuration:
- `/config/products.php` - Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
- `/config/services.php` - Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Keycloak

---

### ÙÙŠ Training Platform:

- `/app/Http/Controllers/Api/TenantController.php` - API Ù„Ø¥Ù†Ø´Ø§Ø¡ Tenants
- `/app/Http/Controllers/Api/KeycloakWebhookController.php` - Ø§Ø³ØªÙ„Ø§Ù… Webhooks
- `/app/Services/KeycloakAdminService.php` - Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
- `/app/Models/Tenant.php` - Model Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†
- `/database/migrations/add_keycloak_columns_to_tenants.php` - Ø­Ù‚ÙˆÙ„ Keycloak

---

### ÙÙŠ Services Platform:

- `/app/Http/Controllers/Api/TenantController.php` - API Ù„Ø¥Ù†Ø´Ø§Ø¡ Tenants
- `/app/Http/Controllers/Api/KeycloakWebhookController.php` - Ø§Ø³ØªÙ„Ø§Ù… Webhooks
- `/app/Services/KeycloakAdminService.php` - Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
- `/app/Models/Tenant.php` - Model Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†

---

### ÙÙŠ Kayan ERP (Frappe):

#### Setup & Configuration:
- `/kayan-erp/apps/oidc_extended/oidc_extended/setup.py`
  - `keycloak_webhook_setup()` - Ø§Ø³ØªÙ„Ø§Ù… Webhook Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±
  - `configure_keycloak()` - Ø¶Ø¨Ø· Social Login Key
  - `sync_group_role_mappings()` - Ø¥Ù†Ø´Ø§Ø¡ Group-Role Mappings

#### Role Synchronization:
- `/kayan-erp/apps/oidc_extended/oidc_extended/sync.py`
  - `get_client_credentials_token()` - Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¨Ù€ Client Credentials
  - `sync_roles_with_client_credentials()` - Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¢Ù…Ù†Ø©

#### Site Creation:
- `/kayan-erp/scripts/create_tenant_site.py` - Python Script Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆÙ‚Ø¹ Ù…Ø¹Ø²ÙˆÙ„
- `/kayan-erp/scripts/setup_keycloak_integration.py` - **DEPRECATED** (Ù„Ø§ ÙŠÙØ³ØªØ®Ø¯Ù…)

#### Authentication:
- `/kayan-erp/apps/oidc_extended/oidc_extended/login.py` - ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ OIDC
- `/kayan-erp/apps/oidc_extended/oidc_extended/callback.py` - Ù…Ø¹Ø§Ù„Ø¬Ø© Callback

---

## ğŸ” Ø§Ø³ØªÙƒØ´Ø§Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡

### 1. Subscription Ù„Ø§ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©

**Ø§Ù„Ø³Ø¨Ø¨:**
- `status` Ù„ÙŠØ³ `'active'`

**Ø§Ù„Ø­Ù„:**
```php
// ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† SubscriptionController ÙŠØ¶Ø¹ status = 'active'
Subscription::create([
    'status' => 'active',  // â† Ù…Ù‡Ù…!
    'is_active' => true,
]);
```

---

### 2. Kayan ERP: Webhook ÙØ´Ù„

**Ø§Ù„Ø³Ø¨Ø¨:**
- Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¨Ø¹Ø¯ (URL = null)
- Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ø§ ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° Ø§Ù„Ù…Ø­Ø¯Ø¯

**Ø§Ù„Ø­Ù„:**
```bash
# ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¹Ù…Ù„
cd /home/vboxuser/kayan-erp
bench --site {site_name} serve --port {port}

# ØªØ­Ù‚Ù‚ Ù…Ù† Logs
tail -f sites/{site_name}/logs/frappe.log
```

---

### 3. Ø£Ø¯ÙˆØ§Ø± Ù„Ø§ ØªÙØ²Ø§Ù…Ù† ÙÙŠ Kayan ERP

**Ø§Ù„Ø³Ø¨Ø¨:**
- Client Secret ØºÙŠØ± ØµØ­ÙŠØ­
- ØµÙ„Ø§Ø­ÙŠØ§Øª Client ØºÙŠØ± ÙƒØ§ÙÙŠØ©

**Ø§Ù„Ø­Ù„:**
```bash
# ØªØ­Ù‚Ù‚ Ù…Ù† Client Secret Ø§Ù„Ù…Ø­ÙÙˆØ¸
php artisan tinker --execute="
echo App\Models\Subscription::find({id})->keycloak_client_secret;
"

# ØªØ­Ù‚Ù‚ Ù…Ù† Logs ÙÙŠ Frappe
tail -f /home/vboxuser/kayan-erp/sites/{site_name}/logs/frappe.log
```

---

### 4. Queue Worker Ù„Ø§ ÙŠØ¹Ù…Ù„

**Ø§Ù„Ø­Ù„:**
```bash
# Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù€ Worker
pkill -f "queue:work"
cd /home/vboxuser/saas-marketplace
php artisan queue:work --sleep=3 --tries=3 --timeout=900 > /tmp/queue-worker.log 2>&1 &

# Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù€ Log
tail -f /tmp/queue-worker.log
```

---

### 5. First/Last Name Ù„Ø§ ÙŠÙØ­ÙØ¸

**Ø§Ù„Ø³Ø¨Ø¨:**
- Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ØªØ³ØªØ®Ø¯Ù… `firstName` Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† `first_name`

**Ø§Ù„Ø­Ù„:**
ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙŠØ³ØªØ®Ø¯Ù… `first_name` Ùˆ `last_name`:
```html
<input type="text" name="first_name" />  <!-- ØµØ­ÙŠØ­ -->
<input type="text" name="firstName" />   <!-- Ø®Ø·Ø£ -->
```

---

## âœ… Ø§Ù„Ø®Ù„Ø§ØµØ©

### Ù…Ø§ ØªÙ… ØªØ­Ù‚ÙŠÙ‚Ù‡:

1. âœ… **Ø¹Ø²Ù„ ÙƒØ§Ù…Ù„**: ÙƒÙ„ Ù…Ø³ØªØ£Ø¬Ø± Ù„Ù‡ Realm Ù…Ø¹Ø²ÙˆÙ„ ÙÙŠ Keycloak
2. âœ… **Ø£Ù…Ø§Ù† Ù…Ø­ÙƒÙ…**: ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø­Ø¯ÙˆØ¯Ø© ÙˆÙ…ÙØ§ØªÙŠØ­ ÙØ±ÙŠØ¯Ø© Ù„ÙƒÙ„ Ø§Ø´ØªØ±Ø§Ùƒ
3. âœ… **Ø«Ù„Ø§Ø« Ù…Ù†ØªØ¬Ø§Øª**: Training (Laravel 12), Services (Laravel 12), Kayan ERP (Frappe 14)
4. âœ… **ØªÙƒØ§Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ**: Ù…Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø­ØªÙ‰ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© - ÙƒÙ„ Ø´ÙŠØ¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ
5. âœ… **Ø¥Ø¯Ø§Ø±Ø© Ù…Ø±ÙƒØ²ÙŠØ©**: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§ ÙŠØ­ØªØ§Ø¬ Keycloak Admin Console
6. âœ… **Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø±**:
   - Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØªÙØ²Ø§Ù…Ù† Roles Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ù„Ù‰ Keycloak ÙƒÙ€ Groups
   - Ø§Ù„Ù…ØªØ¬Ø± ÙŠØ¹ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¥Ù„Ù‰ Groups
   - Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØªÙ‚Ø±Ø£ Groups Ù…Ù† Token ÙˆØªØ·Ø¨Ù‚Ù‡Ø§ ÙƒÙ€ Roles
7. âœ… **Social Login Key**: ÙŠØªÙ… Ø¶Ø¨Ø·Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¹Ø¨Ø± Webhook
8. âœ… **OAuth 2.0 Client Credentials**: Ø·Ø±ÙŠÙ‚Ø© Ø¢Ù…Ù†Ø© Ø¨Ø¯ÙˆÙ† admin credentials
9. âœ… **Ø¹Ø²Ù„ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹**: Kayan ERP ÙŠØ³ØªØ®Ø¯Ù… Ù…ÙˆØ§Ù‚Ø¹ Ù…Ø¹Ø²ÙˆÙ„Ø© ØªÙ…Ø§Ù…Ø§Ù‹
10. âœ… **Queue Workers**: Ù…Ø¹Ø§Ù„Ø¬Ø© ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†Ø© Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø·ÙˆÙŠÙ„Ø©

### Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:

| Ø§Ù„Ù…Ù†ØªØ¬ | Ø§Ù„ØªÙ‚Ù†ÙŠØ© | Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø²Ù„ | Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© | Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø± | SSO Button | Status Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ |
|--------|---------|----------|----------|----------------|-----------|---------------------|
| Training | Laravel 12 | Schema-based | OIDC | Client Credentials | Filament Login | active ÙÙˆØ±Ø§Ù‹ |
| Services | Laravel 12 | Schema-based | OIDC | Client Credentials | Filament Login | active ÙÙˆØ±Ø§Ù‹ |
| Kayan ERP | Frappe 14 | Site-based | OIDC + Client Credentials | Client Credentials | Social Login Key | pending â†’ active |

### ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:

| Ø§Ù„Ø·Ø±Ù | Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª | Ø§Ù„Ù‚ÙŠÙˆØ¯ |
|-------|-----------|---------|
| Ø§Ù„Ù…ØªØ¬Ø± | create-realm, manage-users, manage-clients | âŒ delete-realm, âŒ impersonation |
| Training/Services | manage-users, manage-realm, query-groups | âœ… Ù…Ø­Ø¯ÙˆØ¯ Ø¨Ù€ realm ÙˆØ§Ø­Ø¯ |
| Kayan ERP | manage-users, manage-realm, query-groups | âœ… Ù…Ø­Ø¯ÙˆØ¯ Ø¨Ù€ realm ÙˆØ§Ø­Ø¯ |
| Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… | Ø¥Ø¯Ø§Ø±Ø© Ø¹Ø¨Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ØªØ¬Ø± | âŒ Ù„Ø§ ÙˆØµÙˆÙ„ Ù…Ø¨Ø§Ø´Ø± Ù„Ù€ Keycloak |

---

**ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆØ«ÙŠÙ‚:** 2025-11-20
**ğŸ”§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±:** 2.1

**ğŸ“ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:**
- ØªØµØ­ÙŠØ­ Ø¥ØµØ¯Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Training/Services: Laravel 12, Kayan ERP: Frappe 14)
- Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø´Ø§Ù…Ù„ Ø¹Ù† Social Login Key ÙˆØ¢Ù„ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
- ØªÙˆØ¶ÙŠØ­ Ø¢Ù„ÙŠØ© Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØªØ¹ÙŠÙŠÙ†Ù‡Ø§ Ù…Ù† Keycloak Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
- Ø´Ø±Ø­ ÙƒÙŠÙÙŠØ© Ø¸Ù‡ÙˆØ± Ø²Ø± SSO ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
